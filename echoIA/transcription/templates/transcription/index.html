<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transcrição de Áudio</title>
    {% csrf_token %}
</head>
<body>
    <h1>Transcrição de Áudio</h1>
    <button id="start-recording">Iniciar Gravação</button>
    <button id="stop-recording" disabled>Parar Gravação</button>
    <button id="transcribe" disabled>Transcrever</button>

    <!-- Campo fixo para exibir a transcrição e o status de upload -->
    <div id="transcription-result" style="margin-top: 20px; border: 1px solid #ccc; padding: 10px; width: 100%; height: 100px; overflow-y: auto;">
        <p id="transcription-text">A transcrição aparecerá aqui...</p>
    </div>
    <p id="upload-status" style="color: red; font-weight: bold;"></p>

    <!-- Seção para exibir o histórico de transcrições -->
    <h2>Histórico de Transcrições</h2>
    <div id="transcription-history" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
        {% if user_transcriptions %}
            <ul>
                {% for transcription in user_transcriptions %}
                    <li>
                        <strong>{{ transcription.created_at|date:"d/m/Y H:i" }}</strong>: 
                        {{ transcription.text }}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Nenhuma transcrição encontrada.</p>
        {% endif %}
    </div>

    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        let recordingInProgress = false;

        async function startRecording() {
            await fetch('/transcription/start-recording/', { 
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            });
            recordingInProgress = true;
            document.getElementById("stop-recording").disabled = false;
            console.log("Gravação iniciada.");
        }

        async function stopRecording() {
            if (!recordingInProgress) return;

            await fetch('/transcription/stop-recording/', { 
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                }
            });
            recordingInProgress = false;
            document.getElementById("transcribe").disabled = false;
            console.log("Gravação parada.");
        }

        document.getElementById("start-recording").onclick = async () => {
            if (!recordingInProgress) {
                await startRecording();
                document.getElementById("start-recording").disabled = true;
            }
        };

        document.getElementById("stop-recording").onclick = async () => {
            await stopRecording();
            document.getElementById("stop-recording").disabled = true;
            document.getElementById("start-recording").disabled = false;
        };

        document.getElementById("transcribe").onclick = async () => {
            document.getElementById("upload-status").innerText = "Enviando arquivo para transcrição, aguarde...";

            let uploadSuccess = false;
            let attempts = 0;
            const maxAttempts = 5;

            while (!uploadSuccess && attempts < maxAttempts) {
                try {
                    const response = await fetch('/transcription/transcribe/', { 
                        method: 'POST', 
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById("transcription-text").innerText = data.transcription || data.error;
                        uploadSuccess = true;
                        document.getElementById("upload-status").innerText = "";
                    } else {
                        throw new Error("Falha no upload");
                    }
                } catch (error) {
                    attempts++;
                    document.getElementById("upload-status").innerText = `Tentando novamente... (${attempts}/${maxAttempts})`;
                    console.log("Erro ao transcrever:", error);
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }
            }

            if (!uploadSuccess) {
                document.getElementById("upload-status").innerText = "Falha no upload após várias tentativas. Verifique a conexão.";
            }
        };
    </script>
</body>
</html>

